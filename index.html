<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Calendar</title>

<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/alpinejs@latest/dist/cdn.min.js"></script>
<script src="https://unpkg.com/htmx.org@latest"></script>
<script src="https://unpkg.com/hyperscript.org@latest"></script>

<link href="https://unpkg.com/aos@latest/dist/aos.css" rel="stylesheet" />
<script src="https://unpkg.com/aos@latest/dist/aos.js"></script>

<script src="https://unpkg.com/pouchdb@latest/dist/pouchdb.min.js"></script>

<style>
@media print {
  .no-print { display:none; }
  .day-cell { font-size:10px; }
}
</style>
</head>

<body class="bg-gray-50 text-gray-900" x-data="calendarApp()" x-init="init()">

<!-- ===== Timezone Selection Overlay ===== -->
<div x-show="!timezone"
     class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow w-96">
    <h2 class="text-lg font-bold mb-2">Select Timezone</h2>
    <p class="text-sm mb-3">This timezone will be used for all calendar dates.</p>

    <select class="border p-2 w-full"
            x-model="tempTimezone">
      <template x-for="tz in timezones" :key="tz">
        <option :value="tz" x-text="tz"></option>
      </template>
    </select>

    <button class="mt-4 w-full bg-blue-500 text-white py-2"
            @click="confirmTimezone">
      Confirm
    </button>
  </div>
</div>

<header class="p-4 bg-white shadow flex justify-between items-center">
  <h1 class="text-2xl font-bold">Calendar</h1>
  <div class="flex gap-2">
    <button class="px-3 py-1 bg-gray-200" @click="prevMonth">◀</button>
    <div class="font-semibold" x-text="monthLabel"></div>
    <button class="px-3 py-1 bg-gray-200" @click="nextMonth">▶</button>
  </div>
</header>

<section class="p-4">
  <div class="grid grid-cols-7 text-center font-bold">
    <template x-for="d in weekDays" :key="d">
      <div x-text="d"></div>
    </template>
  </div>

  <div class="grid grid-cols-7 border">
    <template x-for="day in calendarDays" :key="day.date">
      <div class="day-cell border p-1 h-32" :class="{'bg-gray-100':!day.current}">
        <div class="text-xs font-bold" x-text="day.label"></div>
        <template x-for="item in day.items" :key="item._id">
          <div class="text-[10px] truncate" x-text="item.text"></div>
        </template>
      </div>
    </template>
  </div>
</section>

<section class="p-4 no-print">
  <h2 class="font-bold mb-2">Add Task / Event / Memo</h2>
  <div class="flex gap-2">
    <input type="date" x-model="form.date" class="border p-1" />
    <input type="text" x-model="form.text" class="border p-1 flex-1" />
    <select x-model="form.type" class="border p-1">
      <option value="task">Task</option>
      <option value="event">Event</option>
      <option value="memo">Memo</option>
    </select>
    <button class="bg-blue-500 text-white px-3" @click="addItem">Add</button>
  </div>
</section>

<footer class="p-4 no-print">
  <button class="bg-gray-300 px-3" onclick="window.print()">Print</button>
</footer>

<script>
function calendarApp() {
  return {
    db:null,
    items:[],
    current:new Date(),

    timezone:null,
    tempTimezone:null,
    timezones:Intl.supportedValuesOf('timeZone'),

    weekDays:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    form:{date:'',text:'',type:'task'},

    init(){
      AOS.init();
      this.db=new PouchDB('calendar');

      this.timezone=localStorage.getItem('timezone');
      this.tempTimezone=this.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

      this.load();
    },

    confirmTimezone(){
      this.timezone=this.tempTimezone;
      localStorage.setItem('timezone',this.timezone);
    },

    async load(){
      const res=await this.db.allDocs({include_docs:true});
      this.items=res.rows.map(r=>r.doc);
    },

    formatDate(d){
      return new Intl.DateTimeFormat('en-CA',{
        timeZone:this.timezone,
        year:'numeric',month:'2-digit',day:'2-digit'
      }).format(d);
    },

    get monthLabel(){
      return new Intl.DateTimeFormat('en-US',{
        timeZone:this.timezone,
        year:'numeric',month:'long'
      }).format(this.current);
    },

    get calendarDays(){
      if(!this.timezone) return [];
      const days=[];
      const y=this.current.getFullYear();
      const m=this.current.getMonth();
      const first=new Date(y,m,1);
      const start=new Date(first);
      start.setDate(start.getDate()-first.getDay());

      for(let i=0;i<42;i++){
        const d=new Date(start);
        d.setDate(start.getDate()+i);
        const key=this.formatDate(d);

        days.push({
          date:key,
          label:d.getDate(),
          current:d.getMonth()===m,
          items:this.items.filter(it=>it.date===key)
        });
      }
      return days;
    },

    async addItem(){
      if(!this.form.date||!this.form.text) return;
      const doc={
        _id:crypto.randomUUID(),
        date:this.form.date,
        text:this.form.text,
        type:this.form.type
      };
      await this.db.put(doc);
      this.items.push(doc);
      this.form.text='';
    },

    prevMonth(){
      this.current=new Date(this.current.getFullYear(),this.current.getMonth()-1,1);
    },
    nextMonth(){
      this.current=new Date(this.current.getFullYear(),this.current.getMonth()+1,1);
    }
  }
}
</script>

</body>
</html>
